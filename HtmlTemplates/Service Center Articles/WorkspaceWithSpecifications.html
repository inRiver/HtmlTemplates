<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>Workspace with Specifications</title>

    <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.4.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/0.9.13/js/bootstrap-multiselect.js"></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/0.9.13/css/bootstrap-multiselect.css" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.7.14/css/bootstrap-datetimepicker.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.15.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.7.14/js/bootstrap-datetimepicker.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>

    <style type="text/css">
        table {
            font-family: arial, sans-serif;
            border-collapse: collapse;
            width: 100%;
        }

        td, th {
            border: 1px solid #dddddd;
            text-align: left;
            padding: 8px;
        }

        #fieldtypeselection > ul {
            list-style-type: none;
            column-count: 3;
        }

        #fieldtypeselection > ul li {
            position: relative;
        }

        #fieldtypeselection > ul li > ul {
            top: -12px;
            left: 190px;
            position: absolute;
            visibility: hidden;
            z-index: 1;
            background: #ffffff;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.25);
            list-style: none;
            width: 190px;
            padding: 10px 0;
            font-size: 14px;
            line-height: 16px;
            letter-spacing: .02em;
        }

        #newValueFieldEdit ul {
            list-style-type: none;
            column-count: 3;
        }

        #newValueFieldEdit ul li {
            position: relative;
        }

        #newValueFieldEdit ul li > ul {
            top: -12px;
            left: 190px;
            position: absolute;
            visibility: hidden;
            z-index: 1;
            background: #ffffff;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.25);
            list-style: none;
            width: 190px;
            padding: 10px 0;
            font-size: 14px;
            line-height: 16px;
            letter-spacing: .02em;
        }

        #valueFieldEditDiv {
            overflow: hidden;
        }

        input[type=text] {
            width: 100%;
        }

        input:invalid {
            border-color: red;
        }

        input, input:valid {
            border-color: #ccc;
        }

        .invalidTextarea {
            border-color: red;
            border-width: 2px;
        }

        .buttonInvalidForInput {
            cursor: not-allowed;
            pointer-events: none;
            /*Button disabled - CSS color class*/
            color: #c0c0c0;
            background-color: #ffffff;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #555;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 2s linear infinite; /* Safari */
            animation: spin 2s linear infinite;
        }

        .optionGroup {
            font-weight: bold;
            font-style: italic;
        }

        #failed {
            color: red;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>

    <script type="text/javascript">
        //THIS NEED TO BE UPDATED FOR THE SPECIFIC ENVIRONMENT
        var apiKey = "391a8bdc903bafb080a12ff756edf0b7";
        var language = "en";
        var baseUrl = "https://apieuw.productmarketingcloud.com/api/v1.0.0/";

        var specificationTypeId = "Specification";
        var chunkSize = 200;

        var foundEntities;
        var workAreasArray;
        var specificationFieldsArray;
        var allCvls = [];
        var specificationLinkTypes;
        var selectedSpecificationId;
        var specificationLinkTypeIds = "ProductSpecifications,Item2SpecificationCorrect";
        var showDataType = false;
        var specifications = new Object();
        var specificationMainNameField = 'SpecificationName';

        window.onload = function () {
            fetchAllOutboundSpecificationLinkTypeIds();
            fetchWorkAreas();
            fetchAllCvls();

            hideSpecificationTemplate();
        }

        var ajaxSettings = {
            dataType: "json",
            contentType: 'application/json',
            headers: {
                'X-inRiver-APIKey': apiKey,
                'Accept': 'application/json',
                'Accept-Language': language
            },
            url: baseUrl,
            processData: true
        }

        function buildAjaxSettings(restOperation) {
            var settings = Object.assign({}, ajaxSettings);
            settings.url = settings.url + restOperation;
            return settings;
        }

        function fetchWorkAreas() {
            $.getJSON(buildAjaxSettings("workareafoldertree?includeCreatedByMe=false"), function(result) {
                console.log("Success");
                console.log(result);
                workAreasArray = result;
                console.log(workAreasArray.length);

                var workareasselectorhtml = '<div id="workareaselector">';
                workareasselectorhtml += '<ul>';
                workareasselectorhtml += '<li id="topLevel" value="none">Common Shared';
                workareasselectorhtml += '<ul>';
                for (var i = 0; i < workAreasArray.length; i++) {
                    if (workAreasArray[i].folders !== undefined) {
                        workareasselectorhtml += renderWorkareaSubLevels(workAreasArray[i]);
                    }
                    else {
                        workareasselectorhtml += '<li value="' + workAreasArray[i].id + '" >' + workAreasArray[i].name + '</li>';
                    }
                }
                workareasselectorhtml += "</ul>";
                workareasselectorhtml += "</div>";

                document.getElementById("workareaselection").innerHTML = workareasselectorhtml;

                $('#workareaselector').jstree({
                    'plugins': ["wholerow", "types"]
                });
                $('#workareaselector').jstree("open_node", $('#topLevel'));

                $('#workareaselector').on("changed.jstree", function (e, data) {
                    console.log(data.node.li_attr.value);
                    fetchspecifications(data.node.li_attr.value);
                });

            });
        }

        function renderWorkareaSubLevels(workarea) {
            var workareasselectorhtml = '<li value="' + workarea.id + '">' + workarea.name;
            workareasselectorhtml += '<ul>';
            for (var j = 0; j < workarea.folders.length; j++) {
                if (workarea.folders[j].folders !== undefined) {
                    workareasselectorhtml += renderWorkareaSubLevels(workarea.folders[j]);
                } else {
                    workareasselectorhtml += '<li value="' + workarea.folders[j].id + '" >' + workarea.folders[j].name + '</li>';
                }
            }
            workareasselectorhtml += "</ul>";
            workareasselectorhtml += "</li>";

            return workareasselectorhtml;
        }

        function fetchAllCvls() {
            $.getJSON(buildAjaxSettings("model/cvls"), function(cvls) {
                cvls.forEach(function (item, index) {
                    var cvlWithValues = item;
                    cvlWithValues.values = [];
                    allCvls.push(cvlWithValues);
                });
            });
        }

        function fetchAllOutboundSpecificationLinkTypeIds() {
            specificationLinkTypeIds = "";
            $.getJSON(buildAjaxSettings("model/entitytypes"), function(entityTypes) {
                var specification = entityTypes.find(function (entityType) {
                    return entityType.id === specificationTypeId;
                });
                var delimiter = "";
                specification.inboundLinkTypes.forEach(function (linkType, index) {
                    specificationLinkTypeIds += delimiter + linkType;
                    delimiter = ",";
                });

                console.log('fetchAllOutboundSpecificationLinkTypeIds');
                console.log(entityTypes);
                console.log(specificationLinkTypeIds);

                specificationMainNameField = specification.displayNameFieldTypeId;
            });
        }

        function getCvlValues(cvlId) {
            var cvl = allCvls.find(function (cvl) {
                return cvl.id === cvlId;
            });
            console.log("Found cvl for cvlId = " + cvlId);
            console.log(cvl);
            if (cvl.values.length === 0) {
                $.getJSON(buildAjaxSettings("model/cvls/" + cvlId + "/values"), function (cvlValues) {
                    cvl.values = cvlValues;
                });
            }
        }

        function fetchspecifications(value) {
            hideSpecificationTemplate();

            if (value === "none") return;

            var entities;
            $.getJSON(buildAjaxSettings("workareafolder/" + value + "/entitylist"), function (entitylist) {
                entities = entitylist;

                console.log("entities:");
                console.log(entities);

                var specificationtemplaterowstyle = document.getElementById('specificationtemplaterow').style;
                specificationtemplaterowstyle.display = 'table-row';

                document.getElementById("specificationtemplateselection").innerHTML = '<div class="loader" />';

                hideSelectFields();

                specifications = new Object();
                var chunkedFoundEntityIds = chunk(entities.entityIds, chunkSize);

                foundEntities = [];
                console.log('chunkedFoundEntityIds');
                console.log(chunkedFoundEntityIds);
                let process = forEachParallel(chunkedFoundEntityIds, getSpecificationNamesForEntityIds, 10);
                process.done(results => {
                    fillspecificationnames(specifications);
                });
            });
        }

        const chunk = (arr, size) =>
            Array.from({ length: Math.ceil(arr.length / size) }, (v, i) =>
                arr.slice(i * size, i * size + size)
            );

        function getSpecificationNamesForEntityIds(entityIds) {
            var ajaxSettings = buildAjaxSettings("entities:fetchdata");
            ajaxSettings.data = JSON.stringify({
                "entityIds": entityIds,
                "objects": "SpecificationSummary",
                "outbound": {
                    "linkTypeIds": specificationLinkTypeIds,
                    "objects": "FieldValues"
                }
            });
            return $.post(ajaxSettings,
                function(entities) {

                    foundEntities = foundEntities.concat(entities);

                    console.log("Success fetching entities");
                    console.log(entities);
                    console.log(foundEntities);

                    for (var i = 0; i < entities.length; i++) {
                        for (var j = 0; j < entities[i].outbound.length; j++) {
                            var specification = entities[i].outbound[j];
                            if (!(specification.entityId in specifications)) {
                                var specificationEntry = new Object();
                                specificationEntry.specificationName = specification.fieldValues
                                    .find(field => field.fieldTypeId === specificationMainNameField).value;
                                specificationEntry.entityCount = 1;
                                specifications[specification.entityId] = specificationEntry;
                            } else {
                                specifications[specification.entityId].entityCount++;
                            }
                        }
                    }

                    console.log("Specifications:");
                    console.log(specifications);
                });
        }

        // https://codereview.stackexchange.com/questions/174310/process-array-with-x-parallel-executions
        function forEachParallel(arrayOfChunks, processChunksFunction, threads) {
            if (!$.isArray(arrayOfChunks)) throw new TypeError('First parameter must be an array');
            if (!$.isFunction(processChunksFunction)) throw new TypeError('Second parameter must be a function');
            if (!$.isNumeric(threads)) throw new TypeError('Third parameter must be a number');

            // The number of threads must be an integer
            threads = parseInt(threads);

            let masterDeferred = new $.Deferred();
            // To hold the result of each func(arr[i]) call
            let results = [];
            // To hold the deferreds that must be resolved before resolving masterDeferred
            let processes = [];
            let percentComplete = 0;

            // Map the input arr into an array of objects to preserve the index information.
            var queue = arrayOfChunks.map((value, index) => ({ index, value }));

            // Create a new "process" for each item in the queue, up to the thread limit
            for (let i = 0; i < Math.min(queue.length, threads); i++) {
                // Note: Don't blindly change `let` to `var` here or this will break
                // this depends on block scoping.
                let process = new $.Deferred();
                processes.push(process.promise());

                (function next() {
                    // Get the next item in the queue
                    let item = queue.shift();
                    if (!item) {
                        // If no items were found, this process is done.
                        process.resolve();
                        return;
                    }

                    // Call the function with the value at this index
                    processChunksFunction(item.value)
                        // Then update the results with the result
                        .done(result => results[item.index] = result)
                        .done(() => {
                            // Update percentage, calling any progress listeners
                            let newPercentage = Math.floor((arrayOfChunks.length - queue.length) * 100 / arrayOfChunks.length);
                            if (newPercentage > percentComplete) {
                                percentComplete = newPercentage;
                                masterDeferred.notify(percentComplete);
                            }
                            // Loop
                            next();
                        });
                }());
            }

            // Resolve the returned deferred value once processing is complete
            $.when(...processes).done(() => masterDeferred.resolve(results));

            return masterDeferred.promise();
        }

        function fillspecificationnames(specifications) {
            console.log('fillspecificationnames() called');

            var specificationnamesselectorhtml = '<select id="specificationnameselector" onchange="displayspecificationfields(this.value)">';
            specificationnamesselectorhtml += '<option value="none">-</option>';
            for (var key in specifications) {
                specificationnamesselectorhtml += '<option value="' + key + '">' + specifications[key].specificationName + " (" + specifications[key].entityCount + ")" + '</option>';
            }
            specificationnamesselectorhtml += "</select>";

            document.getElementById("specificationtemplateselection").innerHTML = specificationnamesselectorhtml;
        }

        function displayspecificationfields(specificationId) {
            hideSelectFields();

            if (specificationId == "none") return;

            selectedSpecificationId = specificationId;
            $.getJSON(buildAjaxSettings("model/specificationtemplates/" + specificationId + "/fieldtypes"), function (specificationFields) {
                console.log("Success fetching specification fields:");
                console.log(specificationFields);

                specificationFieldsArray = specificationFields;

                specificationFieldsArray.forEach(function (item, index) {
                    if (item.dataType === "CVL") {
                        getCvlValues(item.cvlId);
                    }
                });

                ensureSpecificationFields(specificationFieldsArray);

                var fieldtyperowstyle = document.getElementById('fieldtyperow').style;
                fieldtyperowstyle.display = 'table-row';

                specificationFieldsArray = specificationFieldsArray.sort(function (a, b) {
                    return a.index, b.index;
                });

                var categoryIds = [];
                specificationFieldsArray.forEach(function (field, index) {
                    var foundCategoryId = categoryIds.find(function (categoryId) {
                        return field.categoryId === categoryId;
                    });
                    if (foundCategoryId === undefined || foundCategoryId === null) {
                        categoryIds.push(field.categoryId);
                    }
                });

                console.log('categoryIds');
                console.log(categoryIds);

                var fieldspecificationSelectHtml = '<ul><li><input type="checkbox" onclick="checkAllFieldSpecifications()" id="allFieldSpecificationChecker" />&nbsp;Check All</li></ul>';
                fieldspecificationSelectHtml += '<ul id="fieldtypeselector">';
                categoryIds.forEach(function (categoryId, index) {
                    fieldspecificationSelectHtml += '<li><b>' + categoryId + '</b></li>';
                    for (var i = 0; i < specificationFieldsArray.length; i++) {
                        var specificationField = specificationFieldsArray[i];
                        console.log(specificationField);
                        if (!specificationField.isDisabled || specificationField.format !== null) {
                            var disabled = " ";
                            if (categoryId === specificationField.categoryId) {
                                if (specificationField.format !== null) {
                                    disabled = " disabled ";
                                }

                                var elementId = "";
                                if (i == 0) {
                                    elementId = ' id="focusPoint"';
                                }
                                fieldspecificationSelectHtml += '<li><input type="checkbox"' + elementId + ' value="' + specificationFieldsArray[i].id + '"'  + disabled + '/>&nbsp;' + specificationFieldsArray[i].name.en + '</li>';
                            }
                        }
                    }
                });
                fieldspecificationSelectHtml += "</ul>";
                document.getElementById("fieldtypeselection").innerHTML = fieldspecificationSelectHtml;
            });
        }

        function checkAllFieldSpecifications() {
            var checkAllCheckbox = document.getElementById('allFieldSpecificationChecker');
            console.log('allFieldSpecificationChecker checked = ' + checkAllCheckbox.checked);
            if (checkAllCheckbox.checked == true) {
                $('#fieldtypeselector input[type="checkbox"').prop('checked', true);
            } else {
                $('#fieldtypeselector input[type="checkbox"').prop('checked', false);
            }
        }

        function ensureSpecificationFields(specificationFields) {
            console.log('ensureSpecificationFields');
            console.log(specificationFields);
            console.log(foundEntities);
            specificationFields.forEach(function (specificationField, index) {
                var foundEntity = foundEntities.find(function (entity) {
                    var specification = findSpecificationById(entity.specification, specificationField.id);
                    return specification !== undefined;
                });

                if (foundEntity === undefined) {
                    specificationField.isDisabled = true;
                    return false;
                }

                var entitySpec = findSpecificationById(foundEntity.specification, specificationField.id);

                if (entitySpec === undefined) return false;

                specificationField.format = entitySpec.isFormatted ? "formatted" : null;
                specificationField.isDisabled = entitySpec.isReadOnly;
            });
        }

        function findSpecificationById(specifications, specificationId) {
            return specifications.find(function (spec) {
                return spec.specificationFieldTypeId === specificationId;
            });
        }

        function hideSpecificationTemplate() {
            hideElement('specificationtemplaterow');
            hideSelectFields();
        }

        function hideSelectFields() {
            hideElement('fieldtyperow');
        }

        function hideElement(elementId) {
            var style = document.getElementById(elementId).style;
            style.display = 'none';
        }
    </script>
</head>
<body>
    <div class="container">
        <h1>Workspace with Specifications</h1>
        <div class="row">
            <table class="table table-bordered">
                <thead class="thead-dark">
                    <tr>
                        <th scope="col">Step</th>
                        <th scope="col">Selection</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Workarea:</td>
                        <td id="workareaselection"></td>
                    </tr>
                    <tr id="specificationtemplaterow">
                        <td>Specification template:</td>
                        <td id="specificationtemplateselection"></td>
                    </tr>
                    <tr id="fieldtyperow">
                        <td>Select fields:</td>
                        <td id="fieldtypeselection"></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</body>
</html>