<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>Specification Mass Update</title>

    <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.4.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/0.9.13/js/bootstrap-multiselect.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/0.9.13/css/bootstrap-multiselect.css" type="text/css" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.15.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.7.14/js/bootstrap-datetimepicker.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.7.14/css/bootstrap-datetimepicker.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js" ></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />

    <style type="text/css">
        table {
            font-family: arial, sans-serif;
            border-collapse: collapse;
            width: 100%;
        }

        td, th {
            border: 1px solid #dddddd;
            text-align: left;
            padding: 8px;
        }
        
        #fieldtypeselection > ul {
            list-style-type: none;
            column-count: 3;
        }

        #fieldtypeselection > ul li {
            position: relative;
        }

        #fieldtypeselection > ul li > ul {
            top: -12px;
            left: 190px;
            position: absolute;
            visibility: hidden;
            z-index: 1;
            background: #ffffff;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.25);
            list-style: none;
            width: 190px;
            padding: 10px 0;
            font-size: 14px;
            line-height: 16px;
            letter-spacing: .02em;
        }

        #newValueFieldEdit ul {
            list-style-type: none;
            column-count: 3;
        }

        #newValueFieldEdit ul li {
            position: relative;
        }

        #newValueFieldEdit ul li > ul {
            top: -12px;
            left: 190px;
            position: absolute;
            visibility: hidden;
            z-index: 1;
            background: #ffffff;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.25);
            list-style: none;
            width: 190px;
            padding: 10px 0;
            font-size: 14px;
            line-height: 16px;
            letter-spacing: .02em;
        }

        #valueFieldEditDiv {
            overflow: hidden;
        }

        input[type=text] {
            width: 100%;
        }

        input:invalid {
            border-color: red;
        }

        input, input:valid {
            border-color: #ccc;
        }

        .invalidTextarea {
            border-color: red;
            border-width: 2px;
        }

        .buttonInvalidForInput {
            cursor: not-allowed;
            pointer-events: none;
            /*Button disabled - CSS color class*/
            color: #c0c0c0;
            background-color: #ffffff;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #555;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 2s linear infinite; /* Safari */
            animation: spin 2s linear infinite;
        }

        .optionGroup {
            font-weight: bold;
            font-style: italic;
        }
    
        #failed {
            color: red;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>

    <script>
        //BELOW IS CODE TO THROTTLE THE NUMBER OF AJAX REQUEST SO WE DO NOT GET STOPPED BY THE API.

        /**
         * ajaxthrottle.js
         *
         * Usage:
         *
         *     var t = $.ajaxthrottle({
         *        numRequestsPerTimePeriod : N,
         *        timePeriod               : P,
         *        maxConcurrent            : M
         *     });
         *
         *     t.ajax(args);
         *
         * This is just like calling $.ajax(args), except that requests are throttled
         * so that no more than N are initiated in any time period of P milliseconds,
         * and no more than M concurrent (outstanding at the same time) requests are allowed.
         * If N or P is 0, there is no time period based constraint, and if M is 0, there
         * is no constraint on the number of concurrent requests.
         *
         * Mark Phillips <mphillip@unca.edu>
         * Thu Dec 20 11:04:19 2012
         */
        (function ($) {
            $.ajaxthrottle = function (options) {

                var timeout,

                    settings = $.extend({
                        numRequestsPerTimePeriod: 0,
                        timePeriod: 0,
                        maxConcurrent: 9
                    }, options),

                    time = function () {
                        return (new Date()).getTime();
                    },

                    // Array of outstanding requests; these are requests that have
                    // been initiated with a call to $.ajax() but that have not
                    // completed yet.  Each entry in this array is an object of the form
                    //    {
                    //         arguments: the original arguments list passed to .ajax()
                    //              time: the time this request was passed to $.ajax()
                    //          deferred: the jQuery deferred object for this request
                    //    }
                    outstanding_reqs = [],

                    // Array of initiated requests; each entry in this array
                    // is an object just like the ones in the outstanding_reqs
                    // array above, but this array keeps track of all
                    // requests, regardless of whether they have completed.
                    // This list is used to keep track of how many requests
                    // have been initiated in settings.timePeriod.  Requests
                    // that are older than settings.timePeriod milliseconds
                    // get removed from this list when it is purged.
                    initiated_reqs = [],

                    // Array of requests waiting to be initiated
                    waiting_reqs = [],

                    // Purge the initiated reqs list so that it doesn't contain any
                    // reqs from more than settings.timePeriod ms ago.  Return the
                    // amount of time that needs to be waited until the oldest remaining
                    // (after purging) req in the list will be settings.timePeriod ms old.
                    // Do all of this relative to the passed in 'now' value.
                    purge_initiated_reqs = function (now) {
                        if (settings.timePeriod >= 0) {
                            while ((initiated_reqs.length > 0)
                                &&
                                (initiated_reqs[0].time + settings.timePeriod - now <= 0)) {
                                initiated_reqs.shift();
                            }
                            if (initiated_reqs.length > 0) {
                                return initiated_reqs[0].time + settings.timePeriod - now;
                            }
                        }
                        return 0;
                    },

                    // remove a req from the outstanding_reqs list
                    remove_outstanding_req = function (obj) {
                        $.each(outstanding_reqs, function (i) {
                            if (outstanding_reqs[i] === obj) {
                                outstanding_reqs.splice(i, 1);
                                return false;
                            }
                            return true;
                        });
                    },

                    // Initiate the next request on the waiting list, unless we need to wait
                    // till some time has passed or some outstanding requests have completed.
                    process_waiting = function () {
                        var now = time(),
                            delay, req, deferred;

                        if (waiting_reqs.length <= 0) {
                            return;
                        }

                        delay = purge_initiated_reqs(now);

                        // If we have a timePeriod constraint, and the max number of allowed
                        // requests have gone out in that time period, arrange to wait for
                        // 'delay' ms
                        if ((settings.numRequestsPerTimePeriod > 0) && (settings.timePeriod > 0)
                            &&
                            (delay > 0)
                            &&
                            (initiated_reqs.length >= settings.numRequestsPerTimePeriod)) {
                            // clear any existing timeout first, because this one will
                            // require waiting till after it would finish anyway
                            if (timeout !== undefined) {
                                clearTimeout(timeout);
                            }
                            timeout = setTimeout(function () {
                                timeout = undefined;
                                process_waiting();
                            }, delay);
                            return;
                        }

                        // If the max number of allowed requests is outstanding, do nothing;
                        // process_waiting() will get called again when a request completes.
                        if ((settings.maxConcurrent > 0)
                            &&
                            (outstanding_reqs.length >= settings.maxConcurrent)) {
                            return;
                        }

                        // If we make it to here, then it's OK to initiate the next
                        // request in the waiting list
                        req = waiting_reqs.shift();
                        req.time = time();
                        initiated_reqs.push(req);
                        outstanding_reqs.push(req);
                        $.ajax.apply($, req.arguments).done(function () {
                            req.deferred.resolve.apply(req.deferred, arguments);
                        }).fail(function () {
                            req.deferred.reject.apply(req.deferred, arguments);
                        }).always(function () {
                            remove_outstanding_req(req);
                            process_waiting();
                        });

                    }
                    ;

                return {
                    ajax: function () {
                        var deferred = $.Deferred();
                        waiting_reqs.push({ arguments: arguments, deferred: deferred });
                        process_waiting();
                        return deferred.promise();
                    }
                };
            };
        }(jQuery));

        //SETUP THROTTLE SO WE MAX DO 9 CONCURRENT REQUEST ELSE WE WILL GET BLOCKED BY THE REST API.
        var t = $.ajaxthrottle({
            numRequestsPerTimePeriod: 0,
            timePeriod: 0,
            maxConcurrent: 9
        });
        //t.ajax(args);
    </script>

    <script type="text/javascript">
        //THIS NEED TO BE UPDATED FOR THE SPECIFIC ENVIRONMENT
        var apikey = "391a8bdc903bafb080a12ff756edf0b7";
        var language = "en";
        var baseurl = "https://apieuw.productmarketingcloud.com/api/v1.0.0/";

        var specificationTypeId = "Specification";

        var foundEntities;
        var workareasarray;
        var specificationFieldsArray;
        var allCvls = [];
        var specificationLinkTypes;
        var selectedSpecificationId;
        var specificationLinkTypeIds = "ProductSpecifications,Item2SpecificationCorrect";
        var allLanguages;
        var showDataType = false;
        var specifications = new Object();

        window.onload = function () {
            fetchAllOutboundSpecificationLinkTypeIds();
            fetchworkareas();
            fetchAllCvls();
            fetchAllLanguages();
            hideSpecificationTemplate();
        }

        function fetchworkareas() {
            $.ajax({
                type: "GET",
                dataType: "json",
                contentType: 'application/json',
                beforeSend: function (request) {
                    request.setRequestHeader("X-inRiver-APIKey", apikey);
                    request.setRequestHeader("Accept", "application/json");
                    request.setRequestHeader("Accept-Language", language);

                }, // GET /api/v1.0.0/workareafoldertree
                url: baseurl + "workareafoldertree?includeCreatedByMe=false",
                processData: false,
                success: function (workareas) {
                    console.log("Success");
                    console.log(workareas);
                    workareasarray = workareas;
                    console.log(workareasarray.length);
                }, error: function (xhr) {
                    console.log("Error occured.please try again");
                },
                complete: function () {
                    console.log("Completed found: " + workareasarray.length);

                    var workareasselectorhtml = '<div id="workareaselector">';
                    workareasselectorhtml += '<ul>';
                    for (var i = 0; i < workareasarray.length; i++) {
                        if (workareasarray[i].folders !== undefined) {
                            workareasselectorhtml += renderWorkareaSubLevels(workareasarray[i]);
                        }
                        else {
                            workareasselectorhtml += '<li value="' + workareasarray[i].id + '" >' + workareasarray[i].name + '</li>';
                        }
                    }
                    workareasselectorhtml += "</ul>";
                    workareasselectorhtml += "</div>";

                    document.getElementById("workareaselection").innerHTML = workareasselectorhtml;

                    $('#workareaselector').jstree({
                        'plugins': ["wholerow", "types"]
                    });

                    $('#workareaselector').on("changed.jstree", function (e, data) {
                        console.log(data.node.li_attr.value);
                        fetchspecifications(data.node.li_attr.value);
                    });
                }
            });
        }

        function renderWorkareaSubLevels(workarea) {
            var workareasselectorhtml = '<li value="' + workarea.id + '">' + workarea.name;
            workareasselectorhtml += '<ul>';
            for (var j = 0; j < workarea.folders.length; j++) {
                if (workarea.folders[j].folders !== undefined) {
                    workareasselectorhtml += renderWorkareaSubLevels(workarea.folders[j]);
                } else {
                    workareasselectorhtml += '<li value="' + workarea.folders[j].id + '" >' + workarea.folders[j].name + '</li>';
                }
            }
            workareasselectorhtml += "</ul>";
            workareasselectorhtml += "</li>";

            return workareasselectorhtml;
        }

        function fetchAllCvls() {
            $.ajax({
                type: "GET",
                dataType: "json",
                contentType: 'application/json',
                beforeSend: function (request) {
                    request.setRequestHeader("X-inRiver-APIKey", apikey);
                    request.setRequestHeader("Accept", "application/json");
                    request.setRequestHeader("Accept-Language", language);

                },
                url: baseurl + "model/cvls",
                processData: false,
                success: function (cvls) {
                    cvls.forEach(function (item, index) {
                        var cvlWithValues = item;
                        cvlWithValues.values = [];
                        allCvls.push(cvlWithValues);
                    });
                },
                error: function (xhr) {
                    console.log("Error occured.please try again");
                }
            });
        }

        function fetchAllLanguages() {
            $.ajax({
                type: "GET",
                dataType: "json",
                contentType: 'application/json',
                beforeSend: function (request) {
                    request.setRequestHeader("X-inRiver-APIKey", apikey);
                    request.setRequestHeader("Accept", "application/json");
                    request.setRequestHeader("Accept-Language", language);

                },
                url: baseurl + "model/languages",
                processData: false,
                success: function (languages) {
                    allLanguages = languages;
                    console.log(allLanguages);
                },
                error: function (xhr) {
                    console.log("Error occured.please try again");
                }
            });
        }

        function fetchAllOutboundSpecificationLinkTypeIds() {
            specificationLinkTypeIds = "";
            $.ajax({
                type: "GET",
                dataType: "json",
                contentType: 'application/json',
                beforeSend: function (request) {
                    request.setRequestHeader("X-inRiver-APIKey", apikey);
                    request.setRequestHeader("Accept", "application/json");
                    request.setRequestHeader("Accept-Language", language);

                }, // GET /api/v1.0.0/model/entitytypes
                url: baseurl + "model/entitytypes",
                processData: false,
                success: function (entityTypes) {
                    var specification = entityTypes.find(function (entityType) {
                        return entityType.id === specificationTypeId;
                    });
                    var delimiter = "";
                    specification.inboundLinkTypes.forEach(function (linkType, index) {
                        specificationLinkTypeIds += delimiter + linkType;
                        delimiter = ",";
                    });
                    console.log(specificationLinkTypeIds);
                },
                error: function (xhr) {
                    console.log("Error occured.please try again");
                }
            });

        }

        function getCvlValues(cvlId) {
            var cvl = allCvls.find(function (cvl) {
                return cvl.id === cvlId;
            });
            console.log("Found cvl for cvlId = " + cvlId);
            console.log(cvl);
            if (cvl.values.length === 0) {
                t.ajax({
                    type: "GET",
                    dataType: "json",
                    contentType: 'application/json',
                    beforeSend: function (request) {
                        request.setRequestHeader("X-inRiver-APIKey", apikey);
                        request.setRequestHeader("Accept", "application/json");
                        request.setRequestHeader("Accept-Language", language);

                    },
                    url: baseurl + "model/cvls/" + cvlId + "/values",
                    processData: false,
                    success: function (cvlValues) {
                        cvl.values = cvlValues;
                    },
                    error: function (xhr) {
                        console.log("Error occured.please try again");
                    }
                });
            }
        }

        function fetchspecifications(value) {
            hideSpecificationTemplate();

            if (value === "none") return;

            var foundEntities;
            $.ajax({
                type: "GET",
                dataType: "json",
                contentType: 'application/json',
                beforeSend: function (request) {
                    request.setRequestHeader("X-inRiver-APIKey", apikey);
                    request.setRequestHeader("Accept", "application/json");
                    request.setRequestHeader("Accept-Language", language);

                },
                url: baseurl + "workareafolder/" + value + "/entitylist",
                processData: false,
                success: function (entitylist) {
                    foundEntities = entitylist;

                    console.log("foundEntitiesShort:");
                    console.log(foundEntities);
                }, error: function (xhr) {
                    console.log("Error occured.please try again" + xhr);
                },
                complete: function () {
                    var specificationtemplaterowstyle = document.getElementById('specificationtemplaterow').style;
                    specificationtemplaterowstyle.display = 'table-row';

                    document.getElementById("specificationtemplateselection").innerHTML = '<div class="loader" />';

                    hideSelectFields();

                    specifications = new Object();
                    var chunkedFoundEntityIds = chunk(foundEntities.entityIds, 200);
                    console.log('chunkedFoundEntityIds');
                    console.log(chunkedFoundEntityIds);
                    let process = forEachParallel(chunkedFoundEntityIds, getSpecificationNamesForEntityIds, 10);
                    process.done(results => {
                        fillspecificationnames(specifications);
                    });
                }
            });
        }

        const chunk = (arr, size) =>
            Array.from({ length: Math.ceil(arr.length / size) }, (v, i) =>
                arr.slice(i * size, i * size + size)
            );

        function getSpecificationNamesForEntityIds(entityIds) {
            return $.ajax({
                type: "POST",
                dataType: "json",
                contentType: 'application/json',
                data: JSON.stringify({
                    "entityIds": entityIds,
                    "objects": "SpecificationSummary",
                    "outbound": {
                        "linkTypeIds": specificationLinkTypeIds,
                        "objects": "FieldValues"
                    }
                }),
                beforeSend: function (request) {
                    request.setRequestHeader("X-inRiver-APIKey", apikey);
                    request.setRequestHeader("Accept", "application/json");
                    request.setRequestHeader("Accept-Language", language);

                },
                url: baseurl + "entities:fetchdata",
                processData: false,
                success: function (entities) {

                    foundEntities = entities;

                    console.log("Success fetching entities");
                    console.log(entities);

                    for (var i = 0; i < entities.length; i++) {
                        for (var j = 0; j < entities[i].outbound.length; j++) {
                            var specification = entities[i].outbound[j];
                            if (!(specification.entityId in specifications)) {
                                var specificationEntry = new Object();
                                specificationEntry.specificationName = specification.fieldValues.find(field => field.fieldTypeId === 'SpecificationName').value;
                                specificationEntry.entityCount = 1;
                                specifications[specification.entityId] = specificationEntry;
                            } else {
                                specifications[specification.entityId].entityCount++;
                            }
                        }
                    }

                    console.log("Specifications:");
                    console.log(specifications);
                }, error: function (xhr) {
                    console.log("Error occured.please try again: " + xhr);
                }
            })
            .done(result => ({}))
            .fail((_xhr, text) => ({}));
        }

        // https://codereview.stackexchange.com/questions/174310/process-array-with-x-parallel-executions
        function forEachParallel(arrayOfChunks, processChunksFunction, threads) {
            if (!$.isArray(arrayOfChunks)) throw new TypeError('First parameter must be an array');
            if (!$.isFunction(processChunksFunction)) throw new TypeError('Second parameter must be a function');
            if (!$.isNumeric(threads)) throw new TypeError('Third parameter must be a number');

            // The number of threads must be an integer
            threads = parseInt(threads);

            let masterDeferred = new $.Deferred();
            // To hold the result of each func(arr[i]) call
            let results = [];
            // To hold the deferreds that must be resolved before resolving masterDeferred
            let processes = [];
            let percentComplete = 0;

            // Map the input arr into an array of objects to preserve the index information.
            var queue = arrayOfChunks.map((value, index) => ({ index, value }));

            // Create a new "process" for each item in the queue, up to the thread limit
            for (let i = 0; i < Math.min(queue.length, threads); i++) {
                // Note: Don't blindly change `let` to `var` here or this will break
                // this depends on block scoping.
                let process = new $.Deferred();
                processes.push(process.promise());

                (function next() {
                    // Get the next item in the queue
                    let item = queue.shift();
                    if (!item) {
                        // If no items were found, this process is done.
                        process.resolve();
                        return;
                    }

                    // Call the function with the value at this index
                    processChunksFunction(item.value)
                        // Then update the results with the result
                        .done(result => results[item.index] = result)
                        .done(() => {
                            // Update percentage, calling any progress listeners
                            let newPercentage = Math.floor((arrayOfChunks.length - queue.length) * 100 / arrayOfChunks.length);
                            if (newPercentage > percentComplete) {
                                percentComplete = newPercentage;
                                masterDeferred.notify(percentComplete);
                            }
                            // Loop
                            next();
                        });
                }());
            }

            // Resolve the returned deferred value once processing is complete
            $.when(...processes).done(() => masterDeferred.resolve(results));

            return masterDeferred.promise();
        }

        function fillspecificationnames(specifications) {
            console.log('fillspecificationnames() called');

            var specificationnamesselectorhtml = '<select id="specificationnameselector" onchange="displayspecificationfields(this.value)">';
            specificationnamesselectorhtml += '<option value="none">-</option>';
            for (var key in specifications) {
                specificationnamesselectorhtml += '<option value="' + key + '">' + specifications[key].specificationName + " (" + specifications[key].entityCount + ")" + '</option>';
            }
            specificationnamesselectorhtml += "</select>";

            document.getElementById("specificationtemplateselection").innerHTML = specificationnamesselectorhtml;
        }

        function displayspecificationfields(specificationId) {
            hideSelectFields();

            if (specificationId == "none") return;

            selectedSpecificationId = specificationId;
            $.ajax({
                type: "GET",
                dataType: "json",
                contentType: 'application/json',
                beforeSend: function (request) {
                    request.setRequestHeader("X-inRiver-APIKey", apikey);
                    request.setRequestHeader("Accept", "application/json");
                    request.setRequestHeader("Accept-Language", language);

                }, // GET /api/v1.0.0/model/specificationtemplates/{templateId}/fieldtypes
                url: baseurl + "model/specificationtemplates/" + specificationId + "/fieldtypes",
                processData: false,
                success: function (specificationFields) {
                    console.log("Success fetching specification fields:");
                    console.log(specificationFields);

                    specificationFieldsArray = specificationFields;

                    specificationFieldsArray.forEach(function (item, index) {
                        if (item.dataType === "CVL") {
                            getCvlValues(item.cvlId);
                        }
                    });

                    fillInBuggedOutSpecificationFields(specificationFieldsArray);

                }, error: function (xhr) {
                    console.log("Error occured.please try again: " + xhr);
                },
                complete: function () {
                    var fieldtyperowstyle = document.getElementById('fieldtyperow').style;
                    fieldtyperowstyle.display = 'table-row';

                    specificationFieldsArray = specificationFieldsArray.sort(function (a, b) {
                        return a.index, b.index;
                    });

                    var categoryIds = [];
                    specificationFieldsArray.forEach(function (field, index) {
                        var foundCategoryId = categoryIds.find(function (categoryId) {
                            return field.categoryId === categoryId;
                        });
                        if (foundCategoryId === undefined || foundCategoryId === null) {
                            categoryIds.push(field.categoryId);
                        }
                    });

                    console.log('categoryIds');
                    console.log(categoryIds);

                    var fieldspecificationSelectHtml = '<ul id="fieldtypeselector">';
                    categoryIds.forEach(function (categoryId, index) {
                        fieldspecificationSelectHtml += '<li><b>' + categoryId + '</b></li>';
                        for (var i = 0; i < specificationFieldsArray.length; i++) {
                            var specificationField = specificationFieldsArray[i];
                            if (!specificationField.isDisabled || specificationField.format !== null) {
                                var disabled = " ";
                                if (categoryId === specificationField.categoryId) {
                                    if (specificationField.format !== null) {
                                        disabled = " disabled ";
                                    }

                                    var elementId = "";
                                    if (i == 0) {
                                        elementId = ' id="focusPoint"';
                                    }
                                    fieldspecificationSelectHtml += '<li><input type="checkbox"' + elementId + ' value="' + specificationFieldsArray[i].id + '" onclick="fieldTypesSelected(\'' + specificationFieldsArray[i].id + '\')"' + disabled + '/>&nbsp;' + specificationFieldsArray[i].name.en + '</li>';
                                }
                            }
                        }
                    });
                    fieldspecificationSelectHtml += "</ul>";
                    document.getElementById("fieldtypeselection").innerHTML = fieldspecificationSelectHtml;
                }
            });
        }

        function fillInBuggedOutSpecificationFields(specificationFields) {
            specificationFields.forEach(function (specificationField, index) {
                var foundEntity = foundEntities.find(function (entity) {
                    var specification = findSpecficationById(entity.specification, specificationField.id);
                    return specification !== undefined;
                });

                if (foundEntity === undefined) {
                    specificationField.isDisabled = true;
                    return false;
                }

                var entitySpec = findSpecficationById(foundEntity.specification, specificationField.id);

                if (entitySpec === undefined) return false;

                specificationField.format = entitySpec.isFormatted ? "formatted" : null;
                specificationField.isDisabled = entitySpec.isReadOnly;
            });
        }

        function findSpecficationById(specifications, specificationId) {
            return specifications.find(function (spec) {
                return spec.specificationFieldTypeId === specificationId;
            });
        }


        function fieldTypesSelected(specificationFieldId) {
            var checkedFieldTypeIds = [];
            $("#fieldtypeselection input:checked").each(function () {
                checkedFieldTypeIds.push($(this).val());
            });

            var specificationtemplaterowstyle = document.getElementById('valueFieldEditTableId').style;
            specificationtemplaterowstyle.display = 'block';

            var doMassUpdateButtonDivStyle = document.getElementById('doMassUpdateButtonDiv').style;
            doMassUpdateButtonDivStyle.display = 'block';

            console.log("CheckedFileTypeIds:");
            console.log(checkedFieldTypeIds);
            console.log(specificationFieldsArray);

            var selector = '#newValueFieldEdit > #tr_' + specificationFieldId;
            var newValueFieldEditHtml = "";

            if (checkedFieldTypeIds.find(function (id) {
                return specificationFieldId === id;
            }) === undefined) {
                $(selector).remove();
            } else if ($(selector).html() !== undefined) {
                $(selector).html(generateFieldTypeRow(specificationFieldId));
            } else {
                newValueFieldEditHtml += '<tr id="tr_' + specificationFieldId + '">';
                newValueFieldEditHtml += generateFieldTypeRow(specificationFieldId);
                newValueFieldEditHtml += "</tr>";

                $('#newValueFieldEdit').append(newValueFieldEditHtml);
            }

            for (var id in checkedFieldTypeIds) {
                var specificationField = specificationFieldsArray.find(function (specField) {
                    return specField.id === checkedFieldTypeIds[id];
                });
                if (specificationField.dataType === "DateTime") {
                    $('#' + checkedFieldTypeIds[id]).datetimepicker({ inline: true, sideBySide: true, format: 'YYYY-MM-DDTHH:mm' });
                }
            }

            $('#focusPoint').focus();
        }

        function generateFieldTypeRow(specificationFieldId) {
            var specificationField = specificationFieldsArray.find(function (specField) {
                return specField.id === specificationFieldId;
            });

            var newValueFieldEditHtml = "<td>";
            if (showDataType) {
                newValueFieldEditHtml += specificationField.name.en + " (" + specificationField.dataType + ")";
            } else {
                newValueFieldEditHtml += specificationField.name.en;
            }
            if (specificationField.unit !== null && specificationField.unit.length > 0) {
                newValueFieldEditHtml += "&nbsp;(" + specificationField.unit + ")";
            }
            if (specificationField.isMandatory) {
                newValueFieldEditHtml += "*";
            }
            newValueFieldEditHtml += "</td>";

            newValueFieldEditHtml += "<td>";
            if (specificationField.dataType === "CVL") {
                newValueFieldEditHtml += renderCVLHtml(specificationField.cvlId, specificationField.id);
            } else if (specificationField.dataType === "Boolean") {
                newValueFieldEditHtml += renderBooleanHtml(specificationField.id);
            } else if (specificationField.dataType === "LocaleString") {
                newValueFieldEditHtml += renderLocaleStringHtml(specificationField.id);
            } else {
                newValueFieldEditHtml += renderFieldHtml(specificationField.id, specificationField.dataType);
            }
            newValueFieldEditHtml += "</td>";

            return newValueFieldEditHtml;
        }

        function renderCVLHtml(cvlId, specificationFieldTypeId) {
            var cvl = allCvls.find(function (cvl) {
                return cvl.id === cvlId;
            });
            var specificationField = specificationFieldsArray.find(function (specField) {
                return specField.id == specificationFieldTypeId;
            });

            console.log('renderCVLHtml');
            console.log(specificationField);

            var cvlHtml = '<ul id="' + specificationFieldTypeId + '">';
            var inputType = "radio";
            if (specificationField.isMultiValue) {
                inputType = "checkbox";
            }
            cvl.values.forEach(function (item, index) {
                if (cvl.dataType === "String") {
                    cvlHtml += '<li><input type="' + inputType + '" value="' + item.key + '" name="' + specificationFieldTypeId + '"/>&nbsp;' + item.value + '</li>';
                } else {
                    cvlHtml += '<li><input type="' + inputType + '" value="' + item.key + '" name="' + specificationFieldTypeId + '"/>&nbsp;' + item.value.en + '</li>';
                }
            });
            cvlHtml += "</ul>";

            return cvlHtml;
        }

        function renderBooleanHtml(specificationFieldTypeId) {
            var booleanHtml = '<ul id="' + specificationFieldTypeId + '">';
            booleanHtml += '<li><input type="radio" value="true" name="' + specificationFieldTypeId + '"/>&nbsp;True</li>';
            booleanHtml += '<li><input type="radio" value="false" name="' + specificationFieldTypeId + '"/>&nbsp;False</li>';
            booleanHtml += "</html>";

            return booleanHtml;
        }

        function renderLocaleStringHtml(specificationFieldTypeId) {
            var localeStringHtml = '<div class="row">';
            allLanguages.forEach(function (language) {
                localeStringHtml += '<div class="col-lg-2">';
                localeStringHtml += language.displayName + ':';
                localeStringHtml += '</div>';
                localeStringHtml += '<div class="col-lg-10">';
                localeStringHtml += '<textarea rows="3" id="' + specificationFieldTypeId + ':' + language.name + '" cols="80"></textarea>';
                localeStringHtml += '</div>';
            });

            return localeStringHtml;
        }

        function renderFieldHtml(specificationFieldTypeId, dataType) {
            var pattern = "";
            if (dataType === "Integer") {
                pattern = "^([+-]?[0-9]*)$";
            }
            else if (dataType === "Double") {
                pattern = "^[-+]?[0-9]*\\.?[0-9]+$";
            }
            else if (dataType === "DateTime") {
                pattern = "\\d{4}-[01]\\d-[0-3]\\dT[0-2]\\d:[0-5]\\d:[0-5]\\d(?:\\.\\d+)?Z?";
            }

            if (dataType === "DateTime") {
                return '<input type="text"  id="' + specificationFieldTypeId + '"/>';
            }
            else if (pattern.length > 0) {
                return '<input type="text" id="' + specificationFieldTypeId + '" pattern="' + pattern + '" onkeyup="validate()"/>';
            }
            return '<input type="text" id="' + specificationFieldTypeId + '"/>';
        }

        function validate() {
            var isValid = true;
            console.log('validate');
            $('input[type=text]').each(function (index, input) {
                var regExp = $(this).attr('pattern');
                var value = $(this).val();
                if (regExp !== undefined && value !== undefined && regExp.length > 0 && value.length > 0) {
                    if (!value.match(regExp)) {
                        isValid = false;
                    }
                }
            });

            if (!isValid) {
                console.log('addClass("buttonInvalidForInput")');
                $('#doMassUpdate').addClass('buttonInvalidForInput');
            } else {
                console.log('removeClass("buttonInvalidForInput")');
                $('#doMassUpdate').removeClass('buttonInvalidForInput');
            }
        }

        function hideSpecificationTemplate() {
            hideElement('specificationtemplaterow');
            hideSelectFields();
        }

        function hideSelectFields() {
            hideElement('fieldtyperow');
            hideValueFieldEditTable();
        }

        function hideValueFieldEditTable() {
            hideElement('valueFieldEditTableId');
            hideElement('doMassUpdateButtonDiv');
        }

        function hideElement(elementId) {
            var style = document.getElementById(elementId).style;
            style.display = 'none';
        }

        function doMassUpdate() {
            var specificationValuesForUpdate = [];

            console.log("selectedSpecificationId: " + selectedSpecificationId);

            var entitiesWithSelectedSpecification = [];
            foundEntities.forEach(function (entity) {
                if (entity.outbound.length > 0) {
                    if (entity.outbound[0].entityId == selectedSpecificationId) {
                        entitiesWithSelectedSpecification.push(entity);
                    }
                }
            });
            console.log("EntitiesWithSelectedSpecification:");
            console.log(entitiesWithSelectedSpecification);

            $("#newValueFieldEdit input:checked").each(function () {
                var specFieldId = $(this).attr('name');
                var specificationField = specificationFieldsArray.find(function (specField) {
                    return specField.id == specFieldId;
                });

                console.log("specFieldId = " + specFieldId);
                console.log("specificationField = " + specificationField);
                console.log(allCvls);

                var specificationValue = new Object();
                specificationValue.specificationFieldTypeId = specFieldId;

                var newSpecificationValue = true;
                if (specificationField.dataType === "Boolean") {
                    specificationValue.value = $(this).val() == "true";
                }
                else if (specificationField.dataType === "CVL") {
                    if (specificationField.isMultiValue) {
                        var potentialSpecificationValue = specificationValuesForUpdate.find(function (value) {
                            return value.specificationFieldTypeId == specFieldId;
                        });
                        if (potentialSpecificationValue != undefined) {
                            specificationValue = potentialSpecificationValue;
                            newSpecificationValue = false;
                        } else {
                            specificationValue.value = [];
                        }
                        specificationValue.value.push($(this).val());
                    } else {
                        specificationValue.value = $(this).val();
                    }
                }
                if (newSpecificationValue) {
                    specificationValuesForUpdate.push(specificationValue);
                }
            });

            $("#newValueFieldEdit input[type=text]").each(function () {
                var specFieldId = $(this).attr('id');
                var fieldValue = $(this).val();
                if (fieldValue.length > 0) {
                    var specificationField = specificationFieldsArray.find(function (specField) {
                        return specField.id == specFieldId;
                    });

                    var specificationValue = new Object();
                    specificationValue.specificationFieldTypeId = specFieldId;
                    if (specificationField.dataType === "Integer" || specificationField.dataType === "Double") {
                        specificationValue.value = Number(fieldValue);
                    } else {
                        specificationValue.value = fieldValue;
                    }
                    specificationValuesForUpdate.push(specificationValue);
                }
            });

            $("#newValueFieldEdit textarea").each(function () {
                var htmlId = $(this).attr('id').split(':');
                var specFieldId = htmlId[0];
                var languageCode = htmlId[1];

                var fieldValue = $(this).val();
                var currentSpecificationValueForUpdate = specificationValuesForUpdate.find(function (specForUpdate) {
                    return specForUpdate.specificationFieldTypeId === specFieldId;
                });

                if (currentSpecificationValueForUpdate === undefined) {
                    var specificationValue = new Object();
                    specificationValue.specificationFieldTypeId = specFieldId;
                    specificationValue.value = new Object();
                    specificationValue.value[languageCode] = fieldValue;
                    specificationValuesForUpdate.push(specificationValue);
                } else {
                    currentSpecificationValueForUpdate.value[languageCode] = fieldValue;
                }
            });

            console.log("SpecificationValuesForUpdate:");
            console.log(specificationValuesForUpdate);

            var entityUpdateCount = 0;
            var totalEntities = entitiesWithSelectedSpecification.length;

            document.getElementById("totalItems").innerHTML = "Total entities to update: " + totalEntities;

            var failedEntityIds = [];
            entitiesWithSelectedSpecification.forEach(function (entity, index) {
                t.ajax({
                    type: "PUT",
                    dataType: "json",
                    contentType: 'application/json',
                    data: JSON.stringify(specificationValuesForUpdate),
                    beforeSend: function (request) {
                        request.setRequestHeader("X-inRiver-APIKey", apikey);
                        request.setRequestHeader("Accept", "application/json");
                        request.setRequestHeader("Accept-Language", language);

                    }, // PUT /api/v1.0.0/entities/{entityId}/specificationvalues
                    url: baseurl + "entities/" + entity.entityId + "/specificationvalues",
                    processData: false,
                    success: function (specificationFields) {
                    }, error: function (xhr) {
                        failedEntityIds.push(entity.entityId);

                        var failedHtml = "Failed entity id(s): ";
                        var divider = "";
                        failedEntityIds.forEach(function(id, index) {
                            failedHtml += divider + id;
                            divider = ',';
                        });

                        document.getElementById("failed").innerHTML = failedHtml;
                    },
                    complete: function () {
                        entityUpdateCount++;
                        document.getElementById("progress").innerHTML = "Progress: " + Math.round(entityUpdateCount / totalEntities * 100) + " %";
                    }
                });
            });
        }

    </script>

</head>
<body>
    <div class="container">
        <h1>Specification Mass Update</h1>
        <div class="row">
            <table class="table table-bordered">
                <thead class="thead-dark">
                    <tr>
                        <th scope="col">Step</th>
                        <th scope="col">Selection</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Workarea:</td>
                        <td id="workareaselection"></td>
                    </tr>
                    <tr id="specificationtemplaterow">
                        <td>Specification template:</td>
                        <td id="specificationtemplateselection"></td>
                    </tr>
                    <tr id="fieldtyperow">
                        <td>Select fields:</td>
                        <td id="fieldtypeselection"></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div id="valueFieldEditDiv" class="row">
            <div class="col-lg-12">
                <table id="valueFieldEditTableId" class="table table-bordered">
                    <thead>
                        <tr>
                            <th class="col-xs-2">Field</th>
                            <th class="col-xs-10">New value</th>
                        </tr>
                    </thead>
                    <tbody id="newValueFieldEdit"></tbody>
                </table>
            </div>
        </div>
        <div id="doMassUpdateButtonDiv" class="row">
            <div class="col-lg-2">
                <button onclick="doMassUpdate()" class="btn btn-primary" id="doMassUpdate">Do MassUpdate</button>
            </div>
            <div class="col-lg-10">
                <div class="row">
                    <div class="col-lg-4">
                        <p id="totalItems"></p>
                    </div>
                    <div class="col-lg-4">
                        <p id="progress"></p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-8">
                        <p id="failed"></p>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-12">
                <br />
                <br />
                <br />
            </div>
        </div>
    </div>
</body>
</html>