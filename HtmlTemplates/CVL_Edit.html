<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>CVL Editor</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
</head>
<body class="container mt-4">
    <div id="app">
    <div class="container p-3 my-3 border d-flex justify-content-between">
        <h1>CVL</h1>
        <button class="btn btn-info" v-on:click="addCvl()" v-if="mode=='cvlListing'">Add CVL</button>
    </div>
    <div v-if="mode=='cvlListing'">
            <table class="table table-bordered table-hover table-sm">
                <thead class="thead-light">
                    <tr>
                        <th class="col-xs-3">Id</th>
                        <th class="col-xs-2">Data Type</th>
                        <th class="col-xs-3"></th>
                    </tr>
                </thead>
                <tbody v-for="cvl in allCvls">
                    <tr>
                        <td v-on:click="cvlValueEdit(cvl)">
                            <div v-if="!cvl.editing">{{cvl.id}}</div>
                            <div v-if="cvl.editing">
                                <input type="text" v-model="currentCvl.id"/>
                            </div>
                        </td>
                        <td>
                            <div v-if="!cvl.editing">{{cvl.dataType}}</div>
                            <div v-if="cvl.editing">
                                <select v-on:change="this.currentCvl.dataType=this.value">
                                    <option>-</option>
                                    <option>String</option>
                                    <option>LocaleString</option>
                                </select>
                            </div>
                        </td>
                        <td class="text-center">
                            <button class="btn btn-info" v-if="!cvl.editing" v-on:click="removeCvl(cvl)">Delete</button>
                            <button class="btn btn-info" v-if="cvl.editing" v-on:click="saveCvl(cvl)">Save</button>
                            <button class="btn btn-info" v-if="cvl.editing" v-on:click="cancelCvl(cvl)">Cancel</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div v-if="mode=='cvlEditLocaleString'">
            <table></table>
        </div>
        <div v-if="mode=='cvlEditString'">
            <table class="table table-bordered table-hover table-sm">
                <thead class="thead-light">
                    <tr>
                        <th class="col-xs-3">Key</th>
                        <th class="col-xs-2">Index</th>
                        <th class="col-xs-4">Value</th>
                        <th class="col-xs-3"></th>
                    </tr>
                </thead>
                <tbody v-for="cvlValue in currentCvl.values">
                    <tr>
                        <td>
                            {{cvlValue.key}}
                        </td>
                        <td>
                            {{cvlValue.index}}
                        </td>
                        <td>
                            {{cvlValue.value}}
                        </td>
                        <td>
                            <button class="btn btn-info">Edit</button>
                            <button class="btn btn-info">Delete</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script>

    <script>
        var fallbackApiKey = "2eb0108ce0eefd1b959f3c0a96a27328";
        var apiKey = fallbackApiKey;
        var language = "en";
        var baseUrl = "https://apieuw.productmarketingcloud.com/api/v1.0.0/";

        var app = new Vue({
            el: "#app",
            data: {
                allCvls: [],
                mode: "cvlListing",
                currentCvl: null
            },
            mounted: function () {
                this.fetchAllCvls();
            },
            methods: {
                fetchAllCvls: function () {
                    var self = this;
                    $.getJSON(buildAjaxSettings("model/cvls", false), function (cvls) {
                        cvls.forEach(function (item, index) {
                            var cvlWithValues = item;
                            cvlWithValues.values = [];
                            cvlWithValues.editing = false;
                            self.allCvls.push(cvlWithValues);
                        });
                    });
                },
                cvlValueEdit: function (cvl) {
                    if (cvl.editing) {
                        return;
                    }

                    fetchCvlValues(cvl);
                    if (cvl.dataType === "LocaleString") {
                        this.mode = "cvlEditLocaleString";
                    }
                    if (cvl.dataType === "String") {
                        this.mode = "cvlEditString";
                    }
                    this.currentCvl = cvl;
                },
                removeCvl: function(cvl) {

                },
                addCvl: function () {
                    if (this.currentCvl !== null && this.currentCvl.editing) {
                        return;
                    }

                    var cvl = {
                        id: "",
                        dataType: "",
                        values: [],
                        editing: true
                    };
                    this.allCvls.unshift(cvl);
                    this.currentCvl = cvl;
                },
                cancelCvl: function() {
                    this.currentCvl = null;
                    this.allCvls.shift();
                },
                saveCvl: function () {}
            }
        });

        function fetchCvlValues(cvl) {
            $.getJSON(buildAjaxSettings("model/cvls/" + cvl.id + "/values", false), function (cvlValues) {
                cvl.values = cvlValues;
            });
        };

        function buildAjaxSettings(restOperation, asyncOperation = true) {
            var ajaxSettings = {
                dataType: "json",
                contentType: 'application/json',
                headers: {
                    'X-inRiver-APIKey': apiKey,
                    'Accept': 'application/json',
                    'Accept-Language': language
                },
                url: baseUrl + restOperation,
                processData: true,
                async: asyncOperation
            };
            return ajaxSettings;
        }

    </script>

</body>
</html>